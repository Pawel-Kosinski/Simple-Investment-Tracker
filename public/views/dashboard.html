<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/public/styles/app.css?v=9">
    <style>
        /* Lokalne style specyficzne dla Dashboardu */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
        }

        /* Kolory wartości */
        .positive { color: #16a34a !important; }
        .negative { color: #dc2626 !important; }

        /* Grid Portfeli */
        .portfolios-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
        }
        
        /* Karta Portfela - PEŁNY WYGLĄD */
        .portfolio-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            text-decoration: none;
            color: inherit;
            display: block;
            transition: all 0.2s;
            position: relative; /* Dla przycisku usuwania */
        }
        .portfolio-card:hover { 
            border-color: #9ca3af; 
            transform: translateY(-2px); 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); 
        }
        
        .portfolio-name { font-size: 1.125rem; font-weight: 600; margin-bottom: 0.25rem; }
        .portfolio-value { font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem; }
        
        .portfolio-badges { display: flex; gap: 0.75rem; margin-bottom: 1.5rem; font-size: 0.875rem; align-items: center; }
        
        /* Szczegółowe statystyki w karcie */
        .portfolio-stats {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }
        
        .portfolio-stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
        }
        
        .portfolio-stat-label { color: var(--text-light); }
        .portfolio-stat-value { font-weight: 600; }
        
        /* Badge wewnątrz wierszy statystyk */
        .stat-badge-sm {
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .stat-badge-sm.positive { background: #dcfce7; color: #166534; }
        .stat-badge-sm.negative { background: #fee2e2; color: #991b1b; }
        
        /* Przycisk usuwania w rogu karty */
        .portfolio-delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: transparent;
            border: none;
            font-size: 1.5rem;
            color: var(--text-light);
            cursor: pointer;
            line-height: 1;
            padding: 0 5px;
            border-radius: 4px;
        }
        .portfolio-delete-btn:hover {
            color: var(--negative);
            background: #fee2e2;
        }

        @media (max-width: 900px) {
            .stats-grid, .portfolios-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1 class="logo">Investment Tracker</h1>
        <nav class="nav">
            <a href="/dashboard" class="nav-link active">Podsumowanie</a>
            <a href="/assets" class="nav-link">Aktywa</a>
            <a href="/transactions" class="nav-link">Transakcje</a>
            <a href="/import" class="nav-link">Import</a>
        </nav>
        <div class="user-menu">
            <span class="user-name"><?= htmlspecialchars($userName) ?></span>
            <a href="/logout" class="logout-link">Wyloguj</a>
        </div>
    </header>

    <main class="main">
        <h1 class="section-title">Podsumowanie portfeli w przeliczeniu na PLN</h1>

        <?php
            // Wskaźnik odświeżania (ukryty domyślnie)
            // Możesz go ostylować wedle uznania w CSS
        ?>
        <div id="refreshIndicator" style="display:none; align-items:center; gap:0.5rem; margin-bottom:1rem; font-size:0.875rem; color:var(--text-light);">
            <span class="spinner"></span> Aktualizacja cen...
        </div>
        <div id="lastUpdateTime" style="font-size:0.75rem; color:var(--text-light); margin-bottom:1rem;"></div>

        <?php
            $totalValue = $portfolioSummary['total_value'] ?? 0;
            $totalProfit = $portfolioSummary['total_profit'] ?? 0;
            $currentProfit = $portfolioSummary['current_profit'] ?? 0;
            $totalProfitPercent = $portfolioSummary['total_profit_percent'] ?? 0;
            $dailyChange = $portfolioSummary['daily_change'] ?? 0;
            $dailyChangePercent = $portfolioSummary['daily_change_percent'] ?? 0;
            $gainers = 0; $losers = 0;
            foreach ($holdings ?? [] as $h) {
                if (($h['current_profit'] ?? 0) > 0) $gainers++;
                elseif (($h['current_profit'] ?? 0) < 0) $losers++;
            }
        ?>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Wartość całkowita</div>
                <div class="stat-value" data-stat="total-value"><?= number_format($totalValue, 2, ',', ' ') ?> PLN</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Zmiana dzienna</div>
                <div class="stat-value <?= $dailyChangePercent >= 0 ? 'positive' : 'negative' ?>" data-stat="daily-change-percent">
                    <?= $dailyChangePercent >= 0 ? '+' : '' ?><?= number_format($dailyChangePercent, 2, ',', ' ') ?> %
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Zysk całkowity</div>
                <div class="stat-value <?= $totalProfit >= 0 ? 'positive' : 'negative' ?>" data-stat="total-profit">
                    <?= $totalProfit >= 0 ? '+' : '' ?><?= number_format($totalProfit, 2, ',', ' ') ?> PLN
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Stopa zwrotu</div>
                <div class="stat-value <?= $totalProfitPercent >= 0 ? 'positive' : 'negative' ?>">
                    <?= $totalProfitPercent >= 0 ? '+' : '' ?><?= number_format($totalProfitPercent, 2, ',', ' ') ?> %
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Zysk dzienny (kwotowo)</div>
                <div class="stat-value <?= $dailyChange >= 0 ? 'positive' : 'negative' ?>" data-stat="daily-change">
                    <?= $dailyChange >= 0 ? '+' : '' ?><?= number_format($dailyChange, 2, ',', ' ') ?> PLN
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Zysk bieżący</div>
                <div class="stat-value <?= $currentProfit >= 0 ? 'positive' : 'negative' ?>">
                    <?= number_format($currentProfit, 2, ',', ' ') ?> PLN
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Śr. roczna stopa</div>
                <div class="stat-value <?= $totalProfitPercent >= 0 ? 'positive' : 'negative' ?>">
                    <?= $totalProfitPercent >= 0 ? '+' : '' ?><?= number_format($totalProfitPercent / 3, 2, ',', ' ') ?> %
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Walory wzrostowe</div>
                <div class="stat-value positive"><?= $gainers ?></div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Walory spadkowe</div>
                <div class="stat-value negative"><?= $losers ?></div>
            </div>
        </div>

        <section class="portfolios-section">
            <div class="section-header">
                <h2 class="section-title" style="margin-bottom:0">Portfele</h2>
                <?php if (!empty($portfolios)): ?>
                    <button onclick="openCreatePortfolioModal()" class="btn btn-secondary">➕ Nowy portfel</button>
                <?php endif; ?>
            </div>

            <div class="portfolios-grid">
                <?php if (!empty($portfolios)): ?>
                    <?php foreach ($portfolios as $portfolio): ?>
                        <?php 
                            $pData = $portfolioData[$portfolio->getId()] ?? [];
                            $pValue = $pData['total_value'] ?? 0;
                            $pProfit = $pData['total_profit'] ?? 0;
                            $pProfitPercent = $pData['total_profit_percent'] ?? 0;
                            $pDailyChange = $pData['daily_change'] ?? 0;
                            $pDailyChangePercent = $pData['daily_change_percent'] ?? 0;
                        ?>
                        <a href="/assets?portfolio=<?= $portfolio->getId() ?>" class="portfolio-card" data-portfolio-id="<?= $portfolio->getId() ?>">
                            <div class="portfolio-header">
                                <div class="portfolio-name"><?= htmlspecialchars($portfolio->getName()) ?></div>
                                <div class="portfolio-value"><?= number_format($pValue, 2, ',', ' ') ?> PLN</div>
                            </div>

                            <div class="portfolio-badges">
                                <span class="stat-badge-sm <?= $pProfitPercent >= 0 ? 'positive' : 'negative' ?> profit-badge">
                                    <?= $pProfitPercent >= 0 ? '+' : '' ?><?= number_format($pProfitPercent, 1) ?> %
                                </span>
                                <span class="<?= $pProfit >= 0 ? 'positive' : 'negative' ?> profit-amount" style="font-weight:600;">
                                    <?= $pProfit >= 0 ? '+' : '' ?><?= number_format($pProfit, 2, ',', ' ') ?> PLN
                                </span>
                            </div>

                            <div class="portfolio-stats">
                                <div class="portfolio-stat-row">
                                    <span class="portfolio-stat-label">Zmiana dzienna</span>
                                    <span class="portfolio-stat-value stat-badge-sm <?= $pDailyChangePercent >= 0 ? 'positive' : 'negative' ?> daily-change-percent">
                                        <?= $pDailyChangePercent >= 0 ? '+' : '' ?><?= number_format($pDailyChangePercent, 2) ?> %
                                    </span>
                                </div>
                                <div class="portfolio-stat-row">
                                    <span class="portfolio-stat-label">Zysk dzienny</span>
                                    <span class="portfolio-stat-value stat-badge-sm <?= $pDailyChange >= 0 ? 'positive' : 'negative' ?> daily-change">
                                        <?= $pDailyChange >= 0 ? '+' : '' ?><?= number_format($pDailyChange, 2) ?> PLN
                                    </span>
                                </div>
                                <div class="portfolio-stat-row">
                                    <span class="portfolio-stat-label">Zysk całkowity</span>
                                    <span class="portfolio-stat-value stat-badge-sm <?= $pProfit >= 0 ? 'positive' : 'negative' ?>">
                                        <?= $pProfit >= 0 ? '+' : '' ?><?= number_format($pProfit, 2) ?> PLN
                                    </span>
                                </div>
                            </div>
                            
                            <button type="button" 
                                    onclick="event.preventDefault(); event.stopPropagation(); confirmDeletePortfolio(<?= $portfolio->getId() ?>, '<?= htmlspecialchars($portfolio->getName(), ENT_QUOTES) ?>')" 
                                    class="portfolio-delete-btn" title="Usuń portfel">×</button>
                        </a>
                    <?php endforeach; ?>
                <?php else: ?>
                    <div style="grid-column: 1/-1; text-align:center; padding:3rem; background:white; border-radius:12px; border:1px solid var(--border);">
                        <h3>Brak portfeli</h3>
                        <p>Utwórz swój pierwszy portfel, aby zacząć.</p>
                        <button onclick="openCreatePortfolioModal()" class="btn btn-primary">Utwórz portfel</button>
                    </div>
                <?php endif; ?>
            </div>
        </section>
    </main>

    <div id="createPortfolioModal" class="modal">
        <div class="modal-content">
            <h3>Utwórz nowy portfel</h3>
            <form method="POST" action="/portfolio/create">
                <div class="form-group">
                    <label>Nazwa portfela *</label>
                    <input type="text" name="name" required class="form-input" placeholder="np. Oszczędności">
                </div>
                <div class="form-group">
                    <label>Opis</label>
                    <textarea name="description" rows="3" class="form-input"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" onclick="closeCreatePortfolioModal()" class="btn btn-cancel">Anuluj</button>
                    <button type="submit" class="btn btn-primary">Utwórz portfel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="deletePortfolioModal" class="modal">
        <div class="modal-content">
            <h3>Usuń portfel</h3>
            <p>Czy na pewno chcesz usunąć portfel <strong id="deletePortfolioName"></strong>?</p>
            <p style="color: var(--negative); font-size: 0.85rem; margin-top: 0.5rem;">
                ⚠️ UWAGA: Wszystkie aktywa i transakcje przypisane do tego portfela zostaną trwale usunięte!
            </p>
            <div class="modal-actions">
                <button type="button" onclick="closeModal('deletePortfolioModal')" class="btn btn-cancel">Anuluj</button>
                <button type="button" onclick="executeDeletePortfolio()" class="btn btn-danger">Usuń portfel</button>
            </div>
        </div>
    </div>

    <script>
        function openCreatePortfolioModal() { document.getElementById('createPortfolioModal').style.display = 'flex'; }
        function closeCreatePortfolioModal() { document.getElementById('createPortfolioModal').style.display = 'none'; }
        // Funkcje usuwania są teraz obsługiwane w fetch.js
    </script>
    <script src="/public/scripts/fetch.js"></script>
</body>
</html>