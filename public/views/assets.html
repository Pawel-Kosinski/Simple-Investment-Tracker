<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aktywa - Investment Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/public/styles/app.css?v=6">
</head>
<body>
    <header class="header">
        <h1 class="logo">Investment Tracker</h1>
        <nav class="nav">
            <a href="/dashboard" class="nav-link">Podsumowanie</a>
            <a href="/assets" class="nav-link active">Aktywa</a>
            <a href="/transactions" class="nav-link">Transakcje</a>
            <a href="/import" class="nav-link">Import</a>
        </nav>
        <div class="user-menu">
            <span class="user-name"><?= htmlspecialchars($userName) ?></span>
            <a href="/logout" class="logout-link">Wyloguj</a>
        </div>
    </header>

    <main class="main">
        <div class="page-header">
            <div class="page-title">
                <h2>Twoje aktywa</h2>
                <?php if (!empty($portfolios)): ?>
                <div class="portfolio-filter" style="display:inline-block; margin-left: 1rem;">
                    <select onchange="window.location.href='/assets' + (this.value ? '?portfolio=' + this.value : '')" class="form-select" style="width: auto; padding: 0.5rem 2rem 0.5rem 0.75rem;">
                        <option value="">Wszystkie portfele</option>
                        <?php foreach ($portfolios as $portfolio): ?>
                            <option value="<?= $portfolio->getId() ?>" <?= $activePortfolioId === $portfolio->getId() ? 'selected' : '' ?>>
                                <?= htmlspecialchars($portfolio->getName()) ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <?php endif; ?>
            </div>
        </div>

        <?php if (isset($_SESSION['success'])): ?>
            <div class="alert alert-success"><?= htmlspecialchars($_SESSION['success']) ?></div>
            <?php unset($_SESSION['success']); ?>
        <?php endif; ?>

        <?php if (empty($holdings)): ?>
            <div class="alert alert-warning" style="text-align:center; padding: 3rem;">
                <div style="font-size: 2rem; margin-bottom: 1rem;">üíº</div>
                <p>Brak aktyw√≥w w portfelu.</p>
                <a href="/import" class="btn btn-primary" style="margin-top: 1rem;">Dodaj pierwsze aktywo</a>
            </div>
        <?php else: ?>
            <div class="data-table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Nazwa</th>
                            <th>Ilo≈õƒá</th>
                            <th>≈ör. cena</th>
                            <th>Akt. cena</th>
                            <th>Warto≈õƒá</th>
                            <th>Zysk/Strata</th>
                            <th>Akcje</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach ($holdings as $holding): ?>
                            <tr data-asset-id="<?= $holding['asset_id'] ?>">
                                <td><span class="badge" style="background:#f1f5f9; color:#1e293b;"><?= htmlspecialchars($holding['symbol']) ?></span></td>
                                <td><?= htmlspecialchars($holding['name'] ?? '‚Äî') ?></td>
                                <td><?= number_format($holding['quantity'], 4, ',', ' ') ?></td>
                                <td>
                                    <?= number_format($holding['avg_buy_price'], 2, ',', ' ') ?>
                                    <span style="color:#6b7280; font-size:0.75rem;"><?= $holding['currency'] ?></span>
                                </td>
                                <td>
                                    <?= $holding['current_price'] ? number_format($holding['current_price'], 2, ',', ' ') : '‚Äî' ?>
                                    <?php if($holding['current_price']): ?><span style="color:#6b7280; font-size:0.75rem;"><?= $holding['currency'] ?></span><?php endif; ?>
                                </td>
                                <td style="font-weight:600;">
                                    <?= number_format($holding['current_value_pln'] ?? 0, 2, ',', ' ') ?> <span style="font-size:0.75rem;">PLN</span>
                                </td>
                                <td class="<?= ($holding['current_profit_pln']??0)>=0?'positive':'negative' ?>" style="font-weight:600;">
                                    <?= (($holding['current_profit_pln']??0)>=0?'+':'') . number_format($holding['current_profit_pln']??0, 2, ',', ' ') ?> PLN
                                    <br><small style="font-weight:400;">(<?= (($holding['profit_percent']??0)>=0?'+':'') . number_format($holding['profit_percent']??0, 1, ',', ' ') ?>%)</small>
                                </td>
                                <td>
                                    <button onclick="confirmDelete(<?= $holding['asset_id'] ?>, '<?= htmlspecialchars($holding['symbol'], ENT_QUOTES) ?>')" class="btn btn-cancel" style="padding:0.25rem 0.5rem;" title="Usu≈Ñ">üóëÔ∏è</button>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                    </tbody>
                    <tfoot>
                        <tr class="totals-row">
                            <td colspan="5" class="totals-label">Razem</td>
                            <td class="total-value">
                                <?= number_format($portfolioSummary['total_value'] ?? 0, 2, ',', ' ') ?> PLN
                            </td>
                            <td class="total-profit <?= ($portfolioSummary['total_profit'] ?? 0) >= 0 ? 'positive' : 'negative' ?>">
                                <?= ($portfolioSummary['total_profit'] ?? 0) >= 0 ? '+' : '' ?><?= number_format($portfolioSummary['total_profit'] ?? 0, 2, ',', ' ') ?> PLN
                                <br><small>(<?= ($portfolioSummary['total_profit_percent'] ?? 0) >= 0 ? '+' : '' ?><?= number_format($portfolioSummary['total_profit_percent'] ?? 0, 1, ',', ' ') ?>%)</small>
                            </td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
                
                <div class="table-footer">
                    <span style="font-size: 0.75rem;">Kursy z Yahoo Finance ‚Ä¢ Aktualizacja co 15 min</span>
                    <a href="/dashboard/refresh<?= $activePortfolioId ? '?portfolio=' . $activePortfolioId : '' ?>" class="refresh-link">Od≈õwie≈º kursy</a>
                </div>
            </div>
        <?php endif; ?>
    </main>

    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h3>Potwierd≈∫ usuniƒôcie</h3>
            <p>Czy na pewno chcesz usunƒÖƒá aktywo <strong id="deleteAssetName"></strong>?</p>
            <p style="color: var(--negative); font-size: 0.85rem; margin-top: 0.5rem;">‚ö†Ô∏è Wszystkie transakcje tego aktywa zostanƒÖ usuniƒôte!</p>
            <div class="modal-actions">
                <button onclick="closeModal('deleteModal')" class="btn btn-cancel">Anuluj</button>
                <button onclick="executeDeleteAsset()" class="btn btn-danger">Usu≈Ñ aktywo</button>
            </div>
        </div>
    </div>
    <script src="/public/scripts/fetch.js"></script>
</body>
</html>